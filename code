
import os
import re
import json
import requests
import concurrent.futures
from flask import Flask, request, Response, jsonify

app = Flask(__name__)
app.config['JSON_AS_ASCII'] = False

# 小 Dify 流的配置
DIFY_API_KEY = 'app-lZdOEsax5WX5qaNXqTWxpqHi'
DIFY_API_BASE_URL = 'http://192.168.125.223/v1'

def upload_file_to_dify(tender_file_bytes, user_id):
    """
    上传文件到 Dify 并返回文件信息。
    """
    url = f"{DIFY_API_BASE_URL}/files/upload"
    headers = {'Authorization': f'Bearer {DIFY_API_KEY}'}
    files = {'file': ('tender_file.docx', tender_file_bytes, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document')}
    data = {'user': user_id}

    try:
        response = requests.post(url, headers=headers, files=files, data=data)
        response.raise_for_status()
        uploaded_file_data = response.json()
        print("--- Dify Upload Response ---")
        print(json.dumps(uploaded_file_data, indent=2, ensure_ascii=False))
        print("----------------------------")
        return uploaded_file_data
    except requests.exceptions.RequestException as e:
        print(f"!!! Dify File Upload Error: {e}")
        error_body = e.response.text if e.response else 'No response body'
        print(f"Response Body: {error_body}")
        return None

def call_dify_chat_stream(upload_file_id, dify_user_id, bidding_chunk):
    """
    使用上传的文件 ID 和文本块调用 Dify 的 chat-messages 接口。
    """
    chat_url = f"{DIFY_API_BASE_URL}/chat-messages"
    chat_headers = {
        'Authorization': f'Bearer {DIFY_API_KEY}',
        'Content-Type': 'application/json'
    }
    chat_data = {
        "inputs": {
            "tender_file": {
                "type": "document",
                "transfer_method": "local_file",
                "upload_file_id": upload_file_id
            },
            "bidding_chunk": bidding_chunk
        },
        "query": "开始",
        "response_mode": "streaming",
        "user": dify_user_id
    }

    try:
        print(f"--- Calling Dify Chat API for chunk ---")
        # print(json.dumps(chat_data, indent=2, ensure_ascii=False))
        print("---------------------------------------")

        chat_response = requests.post(chat_url, headers=chat_headers, json=chat_data, stream=True, timeout=300)
        chat_response.raise_for_status()

        full_answer = ""
        for line in chat_response.iter_lines():
            if line:
                decoded_line = line.decode('utf-8')
                if decoded_line.startswith('data:'):
                    try:
                        json_data_str = decoded_line[len('data:'):].strip()
                        if json_data_str.startswith('{'):
                            json_data = json.loads(json_data_str)
                            if 'answer' in json_data:
                                full_answer += json_data['answer']
                    except json.JSONDecodeError:
                        print(f"Could not decode JSON from line: {decoded_line}")
        
        return {"bidding_chunk": bidding_chunk, "result": full_answer}

    except requests.exceptions.RequestException as e:
        print(f"!!! Dify Chat API Error: {e}")
        error_body = e.response.text if e.response else 'No response body'
        print(f"Response Body: {error_body}")
        return {"bidding_chunk": bidding_chunk, "error": str(e), "details": error_body}



@app.route('/upload_and_process', methods=['POST'])
def upload_and_process():
    """
    接收上传的文件，处理后调用 Dify API。
    """
    if 'tender_file' not in request.files or 'bidding_file' not in request.files:
        return jsonify({"error": "Missing tender_file or bidding_file"}), 400

    tender_file = request.files['tender_file']
    bidding_file = request.files['bidding_file']

    tender_file_bytes = tender_file.read()
    bidding_file_bytes = bidding_file.read()
    try:
        bidding_file_content = bidding_file_bytes.decode('utf-8-sig')
    except UnicodeDecodeError:
        bidding_file_content = bidding_file_bytes.decode('gbk', errors='replace')

    # 1. 使用正则表达式按 "## " 分割文件内容
    chunks = re.split(r'(^## .+$)', bidding_file_content, flags=re.MULTILINE)
    
    bidding_chunks = []
    if chunks[0].strip():
        bidding_chunks.append(chunks[0].strip())
    
    for i in range(1, len(chunks), 2):
        chunk_content = chunks[i] + chunks[i+1]
        bidding_chunks.append(chunk_content.strip())

    # 2. 上传一次 tender_file
    user_id = "user123"
    uploaded_file_data = upload_file_to_dify(tender_file_bytes, user_id)
    if not uploaded_file_data:
        return jsonify({"error": "Failed to upload tender file to Dify"}), 500

    upload_file_id = uploaded_file_data['id']
    dify_user_id = uploaded_file_data['created_by']

    # 3. 串行调用 Dify Chat API
    results = []
    for i, chunk in enumerate(bidding_chunks):
        print(f"--- Processing chunk {i+1}/{len(bidding_chunks)} ---")
        result = call_dify_chat_stream(upload_file_id, dify_user_id, chunk)
        results.append(result)
        print(f"--- Finished chunk {i+1}/{len(bidding_chunks)} ---")
    json_response = json.dumps(results, ensure_ascii=False)
    return Response(json_response, content_type='application/json; charset=utf-8')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5001, debug=True)
